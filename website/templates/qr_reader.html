{% extends "base.html" %}
{% block title %}QR Reader{% endblock %}
{% block content %}

<section class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <h1 class="card-title text-center mb-4">QR Code Reader</h1>
                    <div class="form-group text-center mb-4">
                        <label for="camera-selection" class="form-label">Select Camera</label>
                        <select id="camera-selection" class="form-select w-50 mx-auto"></select>
                    </div>
                    <div class="d-flex justify-content-center">
                        <div id="qr-reader" style="position: relative; width: 300px; height: 300px;">
                            <div
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 2px solid #007bff; border-radius: 10px;">
                            </div>
                        </div>
                    </div>
                    <div id="qr-reader-results" class="alert mt-4 text-center" role="alert" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        if (typeof Html5Qrcode === 'undefined') {
            console.error("Html5Qrcode library is not loaded!");
            return;
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`);
            fetch('/process_qr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data: decodedText })
            })
                .then(response => response.json())
                .then(data => {
                    const resultsDiv = document.getElementById('qr-reader-results');
                    if (data.valid) {
                        resultsDiv.className = 'alert alert-success';
                        resultsDiv.innerText = `Valid Entry: ${decodedText}`;
                    } else {
                        resultsDiv.className = 'alert alert-danger';
                        resultsDiv.innerText = `Invalid Entry: ${decodedText}`;
                    }
                    resultsDiv.style.display = 'block';
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        function onScanFailure(error) {
            console.warn(`QR error = ${error}`);
        }

        let html5QrCode = new Html5Qrcode("qr-reader");

        function startQrScanner(cameraId) {
            html5QrCode.start(
                { deviceId: { exact: cameraId } },
                {
                    fps: 10,
                    qrbox: 250
                },
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("Unable to start scanning.", err);
            });
        }

        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                const cameraSelection = document.getElementById('camera-selection');
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.text = device.label;
                    cameraSelection.appendChild(option);
                });

                let currentCameraId = devices[0].id; // Default to the first camera
                startQrScanner(currentCameraId);  // Start with the first camera by default

                cameraSelection.addEventListener('change', (event) => {
                    const selectedCameraId = event.target.value;
                    if (selectedCameraId !== currentCameraId) {
                        html5QrCode.stop().then(() => {
                            currentCameraId = selectedCameraId;
                            startQrScanner(currentCameraId);
                        }).catch(err => {
                            console.error("Unable to stop scanning.", err);
                        });
                    }
                });
            }
        }).catch(err => {
            console.error("Unable to get cameras.", err);
        });
    });
</script>

{% endblock %}